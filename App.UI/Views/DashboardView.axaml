<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:App.UI.ViewModels"
             xmlns:views="using:App.UI.Views"
             x:Class="App.UI.Views.DashboardView"
             x:DataType="vm:DashboardViewModel"
             Background="{StaticResource PrimaryBgBrush}">

    <Grid RowDefinitions="Auto,*" Background="{StaticResource PrimaryBgBrush}">
        <!-- User Header with Logout -->
        <Border Grid.Row="0"
                Background="{StaticResource SecondaryBgBrush}"
                BorderBrush="{StaticResource BorderDefaultBrush}"
                BorderThickness="0,0,0,1"
                Padding="20,10">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="15" VerticalAlignment="Center">
                    <TextBlock Text="TaskManager"
                               FontSize="18"
                               FontWeight="Bold"
                               Foreground="{StaticResource HeadingTextBrush}"/>
                    <TextBlock Text="|"
                               Foreground="{StaticResource LabelTextBrush}"
                               VerticalAlignment="Center"/>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="User:"
                                   Foreground="{StaticResource LabelTextBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding CurrentUsername}"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource InputTextBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="â€¢"
                                   Foreground="{StaticResource LabelTextBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding CurrentUserRole}"
                                   Foreground="{StaticResource TabActiveBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>

                <Button Grid.Column="1"
                        Content="Logout"
                        Command="{Binding LogoutCommand}"
                        Classes="secondary"
                        Padding="16,6"/>
            </Grid>
        </Border>

        <!-- Main Content -->
        <TabControl Grid.Row="1" SelectedIndex="{Binding SelectedTabIndex}" Background="{StaticResource PrimaryBgBrush}">
            <TabItem Header="Admin Panel" IsVisible="{Binding ProjectMasterViewModel.IsAdmin}">
                <Grid RowDefinitions="Auto,*" ColumnDefinitions="2*,3*" Margin="10" Background="{StaticResource PrimaryBgBrush}">
                <!-- Admin Actions Sidebar -->
                <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="0"
                        Background="{StaticResource SecondaryBgBrush}"
                        CornerRadius="12"
                        Padding="20"
                        Margin="0,0,10,0">
                    <Grid RowDefinitions="Auto,Auto,*" HorizontalAlignment="Center" Width="288">
                        <TextBlock Grid.Row="0" Text="Actions" FontSize="18" FontWeight="Bold"
                                   Foreground="{StaticResource HeadingTextBrush}" Margin="0,0,0,15"
                                   HorizontalAlignment="Center"/>

                        <StackPanel Grid.Row="1" Spacing="8" Margin="0,0,0,15">
                            <!-- Admin Only Buttons - Ordered: Create Task, Create Project, Create User, Load Projects, Export, Delete -->
                            <Button Content="Create Task"
                                    Command="{Binding KanbanBoardViewModel.OpenCreateTaskDialogCommand}"
                                    IsVisible="{Binding ProjectMasterViewModel.IsAdmin}"
                                    Width="140"
                                    HorizontalAlignment="Center"
                                    HorizontalContentAlignment="Center"/>

                            <Button Content="Create Project"
                                    Command="{Binding ProjectMasterViewModel.CreateNewProjectCommand}"
                                    IsVisible="{Binding ProjectMasterViewModel.IsAdmin}"
                                    Width="140"
                                    HorizontalAlignment="Center"
                                    HorizontalContentAlignment="Center"/>

                            <Button Content="Create User"
                                    Command="{Binding ProjectMasterViewModel.OpenCreateUserDialogCommand}"
                                    IsVisible="{Binding ProjectMasterViewModel.IsAdmin}"
                                    Width="140"
                                    HorizontalAlignment="Center"
                                    HorizontalContentAlignment="Center"/>

                            <Button Content="Load Projects"
                                    Command="{Binding ProjectMasterViewModel.LoadProjectsForDisplayCommand}"
                                    Width="140"
                                    HorizontalAlignment="Center"
                                    HorizontalContentAlignment="Center"/>

                            <Button Content="Export to CSV"
                                    Command="{Binding ProjectMasterViewModel.ToggleExportDropdownCommand}"
                                    Width="140"
                                    HorizontalAlignment="Center"
                                    HorizontalContentAlignment="Center"/>

                            <!-- Export Dropdown: two 140px buttons centered in 288px container -->
                            <StackPanel IsVisible="{Binding ProjectMasterViewModel.IsExportDropdownVisible}"
                                        Orientation="Horizontal"
                                        HorizontalAlignment="Center"
                                        Spacing="8"
                                        Margin="0,4,0,0">
                                <Button Content="Projects"
                                        Command="{Binding ProjectMasterViewModel.ExportProjectsCommand}"
                                        Width="140"
                                        HorizontalContentAlignment="Center"/>
                                <Button Content="Tasks"
                                        Width="140"
                                        HorizontalContentAlignment="Center"/>
                            </StackPanel>

                            <Button Content="Delete Project"
                                    Command="{Binding ProjectMasterViewModel.DeleteProjectCommand}"
                                    IsVisible="{Binding ProjectMasterViewModel.IsAdmin}"
                                    IsEnabled="{Binding ProjectMasterViewModel.SelectedProject, Converter={x:Static ObjectConverters.IsNotNull}}"
                                    Width="140"
                                    HorizontalAlignment="Center"
                                    HorizontalContentAlignment="Center"
                                    Background="#dc2626"
                                    Foreground="White"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Projects List Panel (Right Container) -->
                <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="1"
                        Background="{StaticResource CardBgBrush}"
                        CornerRadius="12"
                        Padding="20"
                        BorderBrush="{StaticResource BorderDefaultBrush}"
                        BorderThickness="1"
                        IsVisible="{Binding ProjectMasterViewModel.IsProjectsListVisible}">
                    <ScrollViewer>
                        <StackPanel>
                            <TextBlock Text="Projects"
                                       FontSize="18"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource HeadingTextBrush}"
                                       Margin="0,0,0,15"/>

                            <ListBox ItemsSource="{Binding ProjectMasterViewModel.Projects}"
                                     SelectedItem="{Binding ProjectMasterViewModel.SelectedProject}"
                                     Background="{StaticResource CardBgBrush}"
                                     BorderThickness="0">
                                <ListBox.Styles>
                                    <Style Selector="ListBoxItem">
                                        <Setter Property="Background" Value="{StaticResource SecondaryBgBrush}"/>
                                        <Setter Property="Margin" Value="0,0,0,8"/>
                                        <Setter Property="Padding" Value="12"/>
                                        <Setter Property="CornerRadius" Value="8"/>
                                        <Setter Property="BorderBrush" Value="{StaticResource BorderDefaultBrush}"/>
                                        <Setter Property="BorderThickness" Value="1"/>
                                    </Style>
                                    <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                                        <Setter Property="Background" Value="{StaticResource PrimaryButtonBgBrush}"/>
                                    </Style>
                                    <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                                        <Setter Property="Background" Value="{StaticResource PrimaryButtonBgBrush}"/>
                                    </Style>
                                </ListBox.Styles>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel>
                                            <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="{StaticResource InputTextBrush}"/>
                                            <TextBlock Text="{Binding Key}" FontSize="11" Foreground="{StaticResource LabelTextBrush}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </StackPanel>
                    </ScrollViewer>
                </Border>

                <!-- Project Detail Panel -->
                <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="1"
                        Background="{StaticResource CardBgBrush}"
                        CornerRadius="12"
                        Padding="20"
                        BorderBrush="{StaticResource BorderDefaultBrush}"
                        BorderThickness="1"
                        IsVisible="{Binding ProjectMasterViewModel.IsProjectDetailVisible}">
                    <ScrollViewer>
                        <StackPanel DataContext="{Binding ProjectMasterViewModel.ProjectDetailViewModel}">
                            <!-- Title changes based on mode -->
                            <TextBlock Text="Create New Project"
                                       FontSize="18"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource HeadingTextBrush}"
                                       Margin="0,0,0,15"
                                       IsVisible="{Binding IsCreateMode}"/>
                            <TextBlock Text="Project Details"
                                       FontSize="18"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource HeadingTextBrush}"
                                       Margin="0,0,0,15"
                                       IsVisible="{Binding !IsCreateMode}"/>

                            <TextBlock Text="Name:" Foreground="{StaticResource LabelTextBrush}" Margin="0,0,0,5"/>
                            <TextBox Text="{Binding Name}"
                                     Watermark="Enter project name..."
                                     IsReadOnly="{Binding !IsEditMode, FallbackValue=False}"
                                     Margin="0,0,0,5"/>
                            <TextBlock Text="{Binding NameError}"
                               Foreground="#f87171"
                               FontSize="12"
                               Margin="0,0,0,9"
                               IsVisible="{Binding NameError, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                            <TextBlock Text="Key:" Foreground="{StaticResource LabelTextBrush}" Margin="0,0,0,5"/>
                            <TextBox Text="{Binding Key}"
                                     Watermark="e.g., PROJ"
                                     IsReadOnly="{Binding !IsEditMode, FallbackValue=False}"
                                     Margin="0,0,0,5"/>
                            <TextBlock Text="{Binding KeyError}"
                               Foreground="#f87171"
                               FontSize="12"
                               Margin="0,0,0,9"
                               IsVisible="{Binding KeyError, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                            <TextBlock Text="Description:" Foreground="{StaticResource LabelTextBrush}" Margin="0,0,0,5"/>
                            <TextBox Text="{Binding Description}"
                                     Watermark="Enter description (optional)..."
                                     IsReadOnly="{Binding !IsEditMode, FallbackValue=False}"
                                     AcceptsReturn="True"
                                     Height="100"
                                     Margin="0,0,0,14"/>

                            <CheckBox Content="Active"
                                      IsChecked="{Binding IsActive}"
                                      IsEnabled="{Binding IsEditMode}"
                                      IsVisible="{Binding !IsCreateMode}"
                                      Margin="0,0,0,14"/>

                            <!-- Buttons for Edit Mode -->
                            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,15,0,0" IsVisible="{Binding !IsCreateMode}">
                                <Button Content="Edit" Command="{Binding StartEditCommand}" IsVisible="{Binding !IsEditMode}" MinWidth="80" HorizontalContentAlignment="Center"/>
                                <Button Content="Save" Command="{Binding SaveCommand}" IsVisible="{Binding IsEditMode}" MinWidth="80" HorizontalContentAlignment="Center"/>
                                <Button Content="Cancel" Command="{Binding CancelEditCommand}" IsVisible="{Binding IsEditMode}" Classes="secondary" MinWidth="80" HorizontalContentAlignment="Center"/>
                            </StackPanel>

                            <!-- Buttons for Create Mode -->
                            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,15,0,0" IsVisible="{Binding IsCreateMode}">
                                <Button Content="Create" Command="{Binding SaveCommand}" MinWidth="80" HorizontalContentAlignment="Center"/>
                                <Button Content="Cancel" Command="{Binding CancelEditCommand}" Classes="secondary" MinWidth="80" HorizontalContentAlignment="Center"/>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </Border>

                <!-- Delete Confirmation Dialog Overlay -->
                <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="0" Grid.ColumnSpan="2"
                        Background="#80000000"
                        IsVisible="{Binding ProjectMasterViewModel.IsDeleteConfirmationVisible}">
                    <Border Background="{StaticResource SecondaryBgBrush}"
                            CornerRadius="12"
                            Padding="30"
                            Width="400"
                            BorderBrush="{StaticResource BorderDefaultBrush}"
                            BorderThickness="1"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center">
                        <StackPanel Spacing="20">
                            <TextBlock Text="Confirm Deletion"
                                       FontSize="18"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource HeadingTextBrush}"
                                       HorizontalAlignment="Center"/>

                            <StackPanel Spacing="10">
                                <TextBlock Text="Are you sure you want to delete this project?"
                                           Foreground="{StaticResource InputTextBrush}"
                                           TextWrapping="Wrap"
                                           HorizontalAlignment="Center"/>

                                <Border Background="{StaticResource CardBgBrush}"
                                        CornerRadius="8"
                                        Padding="12"
                                        BorderBrush="{StaticResource BorderDefaultBrush}"
                                        BorderThickness="1">
                                    <TextBlock Text="{Binding ProjectMasterViewModel.ProjectToDeleteName}"
                                               FontWeight="Bold"
                                               Foreground="{StaticResource HeadingTextBrush}"
                                               HorizontalAlignment="Center"/>
                                </Border>

                                <TextBlock Text="This action cannot be undone."
                                           Foreground="#f87171"
                                           FontSize="12"
                                           HorizontalAlignment="Center"
                                           Margin="0,5,0,0"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
                                <Button Content="Yes"
                                        Command="{Binding ProjectMasterViewModel.ConfirmDeleteCommand}"
                                        Background="#dc2626"
                                        Foreground="White"
                                        Padding="20,8"/>
                                <Button Content="Cancel"
                                        Command="{Binding ProjectMasterViewModel.CancelDeleteCommand}"
                                        Classes="secondary"
                                        Padding="20,8"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Border>
            </Grid>
        </TabItem>

        <TabItem Header="Dashboard">
            <views:KanbanBoardView DataContext="{Binding KanbanBoardViewModel}"/>
        </TabItem>

        <TabItem Header="Task Manager">
            <views:TaskMasterView DataContext="{Binding TaskMasterViewModel}"/>
        </TabItem>
    </TabControl>
    </Grid>
</UserControl>
