<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:App.UI.ViewModels"
             xmlns:views="using:App.UI.Views"
             x:Class="App.UI.Views.DashboardView"
             x:DataType="vm:DashboardViewModel"
             Background="{StaticResource PrimaryBgBrush}">

    <Grid RowDefinitions="Auto,*" Background="{StaticResource PrimaryBgBrush}">
        <!-- User Header with Logout -->
        <Border Grid.Row="0"
                Background="{StaticResource SecondaryBgBrush}"
                BorderBrush="{StaticResource BorderDefaultBrush}"
                BorderThickness="0,0,0,1"
                Padding="20,10">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="15" VerticalAlignment="Center">
                    <TextBlock Text="TaskManager"
                               FontSize="18"
                               FontWeight="Bold"
                               Foreground="{StaticResource HeadingTextBrush}"/>
                    <TextBlock Text="|"
                               Foreground="{StaticResource LabelTextBrush}"
                               VerticalAlignment="Center"/>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="User:"
                                   Foreground="{StaticResource LabelTextBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding CurrentUsername}"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource InputTextBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="â€¢"
                                   Foreground="{StaticResource LabelTextBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding CurrentUserRole}"
                                   Foreground="{StaticResource TabActiveBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>

                <Button Grid.Column="1"
                        Content="Logout"
                        Command="{Binding LogoutCommand}"
                        Classes="secondary"
                        Padding="16,6"/>
            </Grid>
        </Border>

        <!-- Main Content -->
        <TabControl Grid.Row="1" SelectedIndex="{Binding SelectedTabIndex}" Background="{StaticResource PrimaryBgBrush}">
            <TabItem Header="Projects">
                <Grid RowDefinitions="Auto,*" ColumnDefinitions="2*,3*" Margin="10" Background="{StaticResource PrimaryBgBrush}">
                <!-- Projects Master Sidebar -->
                <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="0"
                        Background="{StaticResource SecondaryBgBrush}"
                        CornerRadius="12"
                        Padding="20"
                        Margin="0,0,10,0">
                    <Grid RowDefinitions="Auto,Auto,*">
                        <TextBlock Grid.Row="0" Text="Projects" FontSize="18" FontWeight="Bold"
                                   Foreground="{StaticResource HeadingTextBrush}" Margin="0,0,0,15"/>

                        <StackPanel Grid.Row="1" Spacing="8" Margin="0,0,0,15">
                            <Button Content="Load Projects" Command="{Binding ProjectMasterViewModel.LoadProjectsCommand}"/>
                            <Button Content="Export to CSV" Command="{Binding ProjectMasterViewModel.ExportToCsvCommand}"/>

                            <!-- Admin Only: Create User Button -->
                            <Button Content="Create User"
                                    Command="{Binding ProjectMasterViewModel.OpenCreateUserDialogCommand}"
                                    IsVisible="{Binding ProjectMasterViewModel.IsAdmin}"/>
                        </StackPanel>

                        <ListBox Grid.Row="2"
                                 ItemsSource="{Binding ProjectMasterViewModel.Projects}"
                                 SelectedItem="{Binding ProjectMasterViewModel.SelectedProject}"
                                 Background="{StaticResource SecondaryBgBrush}"
                                 BorderThickness="0">
                            <ListBox.Styles>
                                <Style Selector="ListBoxItem">
                                    <Setter Property="Background" Value="{StaticResource CardBgBrush}"/>
                                    <Setter Property="Margin" Value="0,0,0,8"/>
                                    <Setter Property="Padding" Value="12"/>
                                    <Setter Property="CornerRadius" Value="8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderDefaultBrush}"/>
                                    <Setter Property="BorderThickness" Value="1"/>
                                </Style>
                                <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                                    <Setter Property="Background" Value="{StaticResource PrimaryButtonBgBrush}"/>
                                </Style>
                                <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                                    <Setter Property="Background" Value="{StaticResource PrimaryButtonBgBrush}"/>
                                </Style>
                            </ListBox.Styles>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="{StaticResource InputTextBrush}"/>
                                        <TextBlock Text="{Binding Key}" FontSize="11" Foreground="{StaticResource LabelTextBrush}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>

                <!-- Project Detail Panel -->
                <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="1"
                        Background="{StaticResource CardBgBrush}"
                        CornerRadius="12"
                        Padding="20"
                        BorderBrush="{StaticResource BorderDefaultBrush}"
                        BorderThickness="1">
                    <ScrollViewer>
                        <StackPanel DataContext="{Binding ProjectMasterViewModel.ProjectDetailViewModel}">
                            <TextBlock Text="Project Details" FontSize="18" FontWeight="Bold"
                                       Foreground="{StaticResource HeadingTextBrush}" Margin="0,0,0,15"/>

                            <TextBlock Text="Name:" Foreground="{StaticResource LabelTextBrush}" Margin="0,0,0,5"/>
                            <TextBox Text="{Binding Name}"
                                     Watermark="Enter project name..."
                                     IsReadOnly="{Binding !IsEditMode}"
                                     Margin="0,0,0,5"/>
                            <TextBlock Text="{Binding NameError}"
                               Foreground="#f87171"
                               FontSize="12"
                               Margin="0,0,0,9"
                               IsVisible="{Binding NameError, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                            <TextBlock Text="Key:" Foreground="{StaticResource LabelTextBrush}" Margin="0,0,0,5"/>
                            <TextBox Text="{Binding Key}"
                                     Watermark="e.g., PROJ"
                                     IsReadOnly="{Binding !IsEditMode}"
                                     Margin="0,0,0,5"/>
                            <TextBlock Text="{Binding KeyError}"
                               Foreground="#f87171"
                               FontSize="12"
                               Margin="0,0,0,9"
                               IsVisible="{Binding KeyError, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                            <TextBlock Text="Description:" Foreground="{StaticResource LabelTextBrush}" Margin="0,0,0,5"/>
                            <TextBox Text="{Binding Description}"
                                     Watermark="Enter description (optional)..."
                                     IsReadOnly="{Binding !IsEditMode}"
                                     AcceptsReturn="True"
                                     Height="100"
                                     Margin="0,0,0,14"/>

                            <CheckBox Content="Active" IsChecked="{Binding IsActive}" IsEnabled="{Binding IsEditMode}" Margin="0,0,0,14"/>

                            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,15,0,0">
                                <Button Content="Edit" Command="{Binding StartEditCommand}" IsVisible="{Binding !IsEditMode}"/>
                                <Button Content="Save" Command="{Binding SaveCommand}" IsVisible="{Binding IsEditMode}"/>
                                <Button Content="Cancel" Command="{Binding CancelEditCommand}" IsVisible="{Binding IsEditMode}" Classes="secondary"/>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>
        </TabItem>

        <TabItem Header="Kanban">
            <views:KanbanBoardView DataContext="{Binding KanbanBoardViewModel}"/>
        </TabItem>
    </TabControl>
    </Grid>
</UserControl>
